# Nixpacks configuration for Railway deployment
# This configuration ensures database migrations run at startup (runtime)
# instead of during build time

[phases.setup]
nixPkgs = ["nodejs_20", "openssl", "bash"]

[phases.install]
cmds = ["npm install"]

[phases.build]
# Only build the application during build phase
# Do NOT run migrations here as database is not accessible during build
cmds = [
  "mkdir -p .next/cache",
  "npx prisma generate",
  "npm run build"
]

[start]
# Use the custom start script that runs migrations at runtime
cmd = "bash start-with-migrate.sh"

[env]
UPLOAD_DIR = "/app/uploads"
